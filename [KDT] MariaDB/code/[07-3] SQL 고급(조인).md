## 7.3 조인

# [실습 11 : 31 ~ 32p]

### 7.3.1 INNER JOIN(내부 조인)

* 조인 중에 가장 많이 사용되는 조인
* 두 개 테이블의 연결 컬럼에 있는 데이타가 모두 존재해야만(교집합) 조회됨

```SQL
-- INNER 조인 형식
SELECT 컬럼1, 컬럼2, ...
  FROM 테이블1
       INNER JOIN 테이블2
	   ON 조인 조건
 WHERE 검색조건
```

* 2개 테이블 조인 예제

```SQL
-- 구매 테이블(buytbl)과 회원 테이블(usertbl)로부터 아이디가 'JYP'인 사람의
-- 이름/주소/연락처, 구매물품명/구매가격/구매수량 조회하기
-- 동일컬럼이 있는 경우 테이블명.컬럼명으로 해야 함. 
USE SQLDB;

SELECT usertbl.name, usertbl.addr, usertbl.mobile1, usertbl.mobile2, buytbl.prodname, buytbl.price, buytbl.amount
  FROM buytbl
          INNER JOIN usertbl
          ON buytbl.userid = usertbl.userid
 WHERE buytbl.userid='JYP';

-- 테이블 별칭 사용
SELECT b.name, b.addr, b.mobile1, b.mobile2, a.prodname, a.price, a.amount
  FROM buytbl a
          INNER JOIN usertbl b
          ON a.userid = b.userid
 WHERE a.userid='JYP';

-- "=" 연산자 활용
SELECT b.userid,b.name, b.addr, b.mobile1, b.mobile2, a.prodname, a.price, a.amount
  FROM buytbl a, usertbl b
 WHERE a.userid = b.userid
    AND a.userid='JYP';
```

* 구매한 이력이 있는 회원 정보 조회 : 중복제거 (회원id, 회원명, 주소)

```SQL
-- 중복 제거 : 속도 이슈 있음
SELECT distinct a.userid, a.name, a.addr
  FROM buytbl b
          INNER JOIN usertbl a
          ON b.userid=a.userid;

-- exists 활용
SELECT a.userid, a.name, a.addr
  FROM usertbl a
 WHERE exists (
		   SELECT *
             FROM buytbl b
            WHERE b.userid = a.userid
	);
```

- 3개 테이블 생성 / 데이타 입력 (dbforge)

```SQL
-- 학생 테이블(stdtbl), 학생_동아리 테이블(stdclubtbl), 동아리 테이블(clubtbl)
-- stdtbl : id(pk), name, addr
-- stdclubtbl : num(pk), id, clubcode
-- clubtbl : clubcode(pk), clubname, roomno
CREATE TABLE stdtbl(
	id 	varchar(10) not null primary key,
	name	varchar(20) not null,
	addr	varchar(10)
	);

CREATE TABLE clubtbl(
	clubcode varchar(10) not null primary key,
	clubname varchar(20) not null,
	roomno varchar(10)
	);

CREATE TABLE stdclubtbl(
	num	int	AUTO_INCREMENT not null primary key,
	id	varchar(10) not null,
	clubcode varchar(10) not null,
	FOREIGN KEY(id) REFERENCES stdtbl(id),
	FOREIGN KEY(clubcode) REFERENCES clubtbl(clubcode)
	);
	
-- 데이타 입력	
INSERT INTO stdtbl VALUES ('K001', '김범수', '경남'), ('S001','성시경', '서울'), ('J001','조용필', '경기'), ('E001','은지원', '경북'), ('B001','바비킴', '서울');
INSERT INTO clubtbl VALUES ('SWIM', '수영', '101호'), ('BADK','바둑', '102호'), ('SOCC','축구', '103호'), ('BONS','봉사', '104호');
INSERT INTO stdclubtbl VALUES (NULL, 'K001', 'BADK'), (NULL, 'K001', 'SOCC'), (NULL, 'J001', 'SOCC'), (NULL, 'E001', 'SOCC'), (NULL, 'E001', 'BONS'), (NULL, 'B001', 'BONS');
```

* 3개 테이블 조인

```SQL
-- 학생 기준으로 조인 : 학생 이름, 지역, 가입한 동아리명, 동아리방 출력
SELECT s.name, s.addr, c.clubname, c.roomno
  FROM stdtbl s
	INNER JOIN stdclubtbl sc
	ON s.id = sc.id
	INNER JOIN clubtbl c
	ON sc.clubcode = c.clubcode;

-- 동아리 가입 기준으로 조인
-- 동아리 가입 기준으로 학생 이름, 지역, 가입한 동아리명, 동아리방 출력
SELECT s.name, s.addr, c.clubname, c.roomno
  FROM stdclubtbl sc
	INNER JOIN stdtbl s
	ON sc.id = s.id
	INNER JOIN clubtbl c
	ON sc.clubcode = c.clubcode;

-- 3개 테이블 조인 : "=" 연산자 활용
SELECT s.name, s.addr, c.clubname, c.roomno
  FROM stdclubtbl sc, stdtbl s, clubtbl c
 WHERE sc.id = s.id
    AND sc.clubcode = c.clubcode;
```



# [실습 12 : 33p]

### 7.3.2 OUTER JOIN(외부 조인)

* 조인의 조건에 만족되지 않는 행까지 포함시키는 것

```SQL
-- OUTER 조인 형식
SELECT 컬럼1, 컬럼2, ...
  FROM 테이블1
       <LEFT | RIGHT | > [OUTER] JOIN 테이블2
	   ON 조인 조건
 WHERE 검색조건
```

* 구매기록이 있는 회원정보와 구매정보 조회

```SQL
SELECT b.userid, b.name, b.addr, a.prodname, a.price, a.amount
  FROM buytbl a
 	INNER JOIN usertbl b
	ON a.userid = b.userid;
```

* 구매기록이 없는 회원정보 포함해서 구매정보 조회

```SQL
SELECT b.userid, b.name, b.addr, a.prodname, a.price, a.amount
  FROM buytbl a
 	RIGHT JOIN usertbl b
	ON a.userid = b.userid;
```

- 참고만 : 학생기준으로 동아리 가입정보 출력하되 동아리 가입하지 않은 인원도 출력

```SQL
SELECT s.name, s.addr, c.clubname, c.roomno
  FROM stdtbl s
	LEFT JOIN stdclubtbl sc
	ON s.id = sc.id
	LEFT JOIN clubtbl c
	ON sc.clubcode = c.clubcode;

-- 4) 참고만 : 동아리기준으로 동아리 정보 출력하되 동아리 가입인원이 없는 동아리도 출력
SELECT s.name, s.addr, c.clubname, c.roomno
  FROM clubtbl c
	LEFT JOIN stdclubtbl sc
	ON c.clubcode = sc.clubcode
	LEFT JOIN stdtbl s
	ON sc.id = s.id;
```

- 참고만 : 두 개의 결과 합치기 : FULL OUTER JOIN (UNION 활용)

  

# [실습 13 : 34 ~ 37p]

### 7.3.3 CROSS JOIN(상호부 조인)

* 한쪽 테이블의 모든 행들과 다른 쪽 테이블의 모든 행을 조인시키는 기능
*  CROSS JOIN의 결과 개수는 두 테이블 개수를 곱한 개수

```SQL
-- WHERE 절이 없는 것과 동일
SELECT *
  FROM buytbl
	CROSS JOIN usertbl;
```

### 7.3.4 SELF JOIN(자체 조인) 

* 자기 자신의 테이블과 조인한다는 의미 : INNER JOIN을 사용하되 동일한 테이블 활용
* 보통 상위정보 필드가 함께 포함되어 있는 경우 주로 사용

```SQL
-- 부서장포함한 직원정보 테이블 생성
CREATE TABLE emptbl (empid char(3) primary key, 
                     empname char(20), 
                     managerid char(3), 
                     emptel varchar(8));
                     
-- 조직에 맞게 데이타 입력                     
INSERT INTO emptbl VALUES('101', '나사장', '101', '0000');
INSERT INTO emptbl VALUES('201', '김재무', '101', '2222');
INSERT INTO emptbl VALUES('202', '김부장', '201', '2222-1');
INSERT INTO emptbl VALUES('203', '이부장', '201', '2222-2');
INSERT INTO emptbl VALUES('204', '우대리', '203', '2222-2-1');
INSERT INTO emptbl VALUES('205', '지사원', '203', '2222-2-2');
INSERT INTO emptbl VALUES('206', '이영업', '101', '1111');
INSERT INTO emptbl VALUES('207', '한과장', '206', '1111-1');
INSERT INTO emptbl VALUES('208', '최정보', '101', '3333');
INSERT INTO emptbl VALUES('209', '윤차장', '208', '3333-1');
INSERT INTO emptbl VALUES('210', '이주임', '209', '3333-1-1');

-- emptbl에서 managerid를 활용하여 본인의 정보와 부서장의 정보 조회
-- 사원 ID, 사원명, 사원 전화번호, 부서장명, 부서장 전화번호
SELECT  a.empid '사원id', a.empname '사원명', a.emptel '사원전화번호', 
		b.empname '부서장 성명', b.emptel '부서장 전화번호'
  FROM  emptbl a
	INNER JOIN emptbl b
	ON a.managerid = b.empid
 WHERE a.empid = '204'	;
```



# [실습 14 : 38 ~ 39p]

### 7.3.5 UNION / UNION ALL / NOT IN / IN / INLINE VIEW

* UNION / UNION ALL : 두 쿼리의 결과를 행으로 합치는 것

   : 대용량테이블을 합할 경우 : 년도별, 월별

* UNION : 중복행 제거

* IN : 데이타 포함 행 조회

* NOT IN : 데이타 포함하지 않은 행 조회

* INLINE VIEW : 가상 뷰 테이블

```SQL
-- 1) UNION
SELECT NAME FROM USERTBL
UNION
SELECT NAME FROM STDTBL;

-- 2) UNION ALL
SELECT NAME FROM USERTBL
UNION ALL
SELECT NAME FROM STDTBL;

-- 3) IN
-- usertbl, '조용필', '김범수'를 포함한 데이타 조회
SELECT * 
  FROM usertbl
 WHERE name in ('조용필','김범수');

-- stdtbl의 name을 포함하고 있는 usertbl의 모든 정보 조회
SELECT *
  FROM usertbl
 WHERE name IN (SELECT name FROM stdtbl)

-- 4) NOT IN
-- usertbl, '조용필', '김범수'를 제외한 데이타 조회
SELECT * 
  FROM usertbl
 WHERE name not in ('조용필','김범수');

-- usertbl의 addr='서울'인 name을 제외한 데이타 조회
SELECT *
  FROM usertbl
 WHERE name NOT IN (SELECT name FROM stdtbl WHERE addr='서울');
 
-- 5) INLINE VIEW
-- userTBL에서 각 지역별로 가장 키가 큰 사람들의 평균 구하기
-- INLINE VIEW 별칭 반드시 사용해야 함
SELECT AVG(a.maxHeight) AS '각 지역별 최고키의 평균'
  FROM (SELECT addr, MAX(height) maxHeight FROM userTBL GROUP BY addr) a;
```
