# 8.1 테이블 실습

##  [교재 333p~342p]

### 1) buyTBL, userTBL 생성

```SQL
use tableDB;
DROP TABLE IF EXISTS buyTBL, userTBL;

CREATE TABLE userTBL
(userID char(8),
 name nvarchar(10),
 birthYear int,
 addr nchar(2),
 mobile1 char(3),
 mobile2 char(8),
 height smallint,
 mDate date
);

CREATE TABLE buyTBL
(num int AUTO_INCREMENT PRIMARY KEY,
 userid char(8),
 prodName nchar(6),
 groupName nchar(4),
 price int,
 amount smallint
);
```



### 2) buyTBL, userTBL 데이타 추가

```SQL
-- '김범수' 출생연도 : NULL  (향후 CHECK 옵션 추가시 오류 발생)
-- '김경호' 출생연도 : 1871  (향후 CHECK 옵션 추가시 오류 발생)
INSERT INTO usertbl VALUES('LSG', '이승기', 1987, '서울', '011', '11111111', 182, '2008-8-8');
INSERT INTO usertbl VALUES('KBS', '김범수', NULL, '경남', '011', '22222222', 173, '2012-4-4');
INSERT INTO usertbl VALUES('KKH', '김경호', 1871, '전남', '019', '33333333', 177, '2007-7-7');
INSERT INTO usertbl VALUES('JYP', '조용필', 1950, '경기', '011', '44444444', 166, '2009-4-4');

-- 'BBK' 회원이 아닌 데이타 INSERT함
INSERT INTO buytbl VALUES(NULL, 'KBS', '운동화',  NULL,  30,   2);
INSERT INTO buytbl VALUES(NULL, 'KBS', '노트북',  '전자',  1000,   1);
INSERT INTO buytbl VALUES(NULL, 'JYP', '모니터',  '전자',  200,   1);
INSERT INTO buytbl VALUES(NULL, 'BBK', '모니터',  '전자',  200,   5);
```



### 3) userTBL에 PRIMARY KEY 생성(PK_userTBL_userID)

```SQL
ALTER TABLE userTBL
	ADD CONSTRAINT PK_userTBL_userID
	PRIMARY KEY userTBL(userID);

DESC userTBL;
```



### 4) 외래 키 생성 buyTBL(userID) -> userTBL(userID)

```SQL
-- userTBL에 'BBK'가 없기 때문에 constraint error 발생
ALTER TABLE buyTBL
	ADD CONSTRAINT fk_userTBL_buyTBL
	FOREIGN KEY buyTBL(userID)
	REFERENCES userTBL(userID);

-- buyTBL의 'BBK' 삭제 후 재수행
DELETE FROM buyTBL WHERE userID='BBK';
ALTER TABLE buyTBL
	ADD CONSTRAINT fk_userTBL_buyTBL
	FOREIGN KEY buyTBL(userID)
	REFERENCES userTBL(userID);
	
-- buyTBL에 insert 시 userTBL에 키 값이 없는 경우 constraint error 발생
INSERT INTO buytbl VALUES(NULL, 'BBK', '모니터',  '전자',  200,   5);

-- 제약조건 비활성화 후 buyTBL INSERT 
-- Child 테이블에 데이타를 먼저 넣고 작업이 필요할 경우 활용
SET foreign_key_checks = 0;
INSERT INTO buytbl VALUES(NULL, 'BBK', '모니터',  '전자',  200,   5);
INSERT INTO buytbl VALUES(NULL, 'KBS', '청바지',  '의류',  50,   3);
INSERT INTO buytbl VALUES(NULL, 'BBK', '메모리',  '전자',  80,   10);
INSERT INTO buytbl VALUES(NULL, 'SSK', '책',       '서적',  15,   5);
INSERT INTO buytbl VALUES(NULL, 'EJW', '책',  	   '서적',  15,   2);
INSERT INTO buytbl VALUES(NULL, 'EJW', '청바지', '의류',  50,   1);
INSERT INTO buytbl VALUES(NULL, 'BBK', '운동화',  NULL, 30,   2);
INSERT INTO buytbl VALUES(NULL, 'EJW', '책', 	  '서적',   15,   1);
INSERT INTO buytbl VALUES(NULL, 'BBK', '운동화', NULL,  30,   2);
SET foreign_key_checks = 1;
```



### 5) check 제약조건 설정

```SQL
-- userTBL의 출생연도 1900~2020, NOT NULL로 변경
ALTER TABLE userTBL
	ADD CONSTRAINT CK_birthYear
	CHECK ((birthYear >= 1900 and birthYear <= 2022) AND (birthYear IS NOT NULL));

-- CHECK 값에 위배되는 데이타가 존재하므로 제약조건 비활성화 다시 수행
SET check_constraint_checks = 0;
ALTER TABLE userTBL
	ADD CONSTRAINT CK_birthYear
	CHECK ((birthYear >= 1900 and birthYear <= 2022) AND (birthYear IS NOT NULL));
SET check_constraint_checks = 1;
```



### 6) userTBL 나머지 데이타 입력

```SQL
INSERT INTO usertbl VALUES('SSK', '성시경', 1979, '서울',  NULL,       NULL, 186, '2013-12-12');
INSERT INTO usertbl VALUES('LJB', '임재범', 1963, '서울', '016', '66666666', 182, '2009-9-9');
INSERT INTO usertbl VALUES('YJS', '윤종신', 1969, '경남',  NULL,       NULL, 170, '2005-5-5');
INSERT INTO usertbl VALUES('EJW', '은지원', 1972, '경북', '011', '88888888', 174, '2014-3-3');
INSERT INTO usertbl VALUES('JKW', '조관우', 1965, '경기', '018', '99999999', 172, '2010-10-10');
INSERT INTO usertbl VALUES('BBK', '바비킴', 1973, '서울', '010', '00000000', 176, '2013-5-5');
```



### 7) 외래키 무결성 훼손 시 데이타 확인

```SQL
-- userTBL 확인
SELECT * FROM userTBL;

-- userTBL의 '바비킴' 회원의 ID를 'BBK' -> 'VVK'로 변경
UPDATE userTBL SET userid='VVK' WHERE userID='BBK';  

-- Foreign key 에러 발생으로 foreign_key_checks = 0으로 변경 후 수행
SET foreign_key_checks = 0;
UPDATE userTBL SET userid='VVK' WHERE userID='BBK';  
SET foreign_key_checks = 1;

-- 두개 테이블 inner join해서 userTBL 전체정보 조회
-- buytbl.userid = 'BBK'인 데이타 제외하고 출력됨
SELECT b.*
  FROM buyTBL a
	INNER JOIN usertbl b
	ON a.userid=b.userid;

-- LEFT JOIN으로 변경
SELECT b.*, a.prodName, a.userid
  FROM buyTBL a
	LEFT JOIN usertbl b
	ON a.userid=b.userid;

-- 바비킴 다시 ID를 'VVK'에서 'BBK'로 변경
UPDATE userTBL SET userid='BBK' WHERE userID='VVK';  
```



### 8) ON UPDATE CASCADE, ON DELETE CASCADE

```SQL
-- buyTBL Foreign Key 삭제
ALTER TABLE buyTBL
	DROP FOREIGN KEY FK_userTBL_buyTBL;

-- buyTBL Foreign Key 생성
-- ON UPDATE CASCADE, ON DELETE CASCADE
ALTER TABLE buyTBL
	ADD CONSTRAINT fk_userTBL_buyTBL
	FOREIGN KEY buyTBL(userID)
	REFERENCES userTBL(userID)
	ON UPDATE CASCADE
	ON DELETE CASCADE;
	
-- userTBL의 '바비킴' 회원의 ID를 'BBK' -> 'VVK'로 변경
UPDATE userTBL SET userid='VVK' WHERE userID='BBK';  

-- userTBL, buyTBL 확인
SELECT * FROM userTBL;
SELECT * FROM buyTBL;

-- 'VVK' 삭제
DELETE FROM userTBL WHERE userID='VVK';  
-- userTBL, buyTBL 확인
SELECT * FROM userTBL;
SELECT * FROM buyTBL;

-- check 제약 조건 있는 컬럼 삭제
-- check 제약조건도 함께 삭제됨
ALTER TABLE userTBL
DROP COLUMN birthYear;	

DESC userTBL;
```