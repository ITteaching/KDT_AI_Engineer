# [실습 6 : 28 ~ 31p]

### 6.2 데이타 변경 SQL 문

### 6.2.1 데이터 삽입 : INSERT

* INSERT문 기본 형식

```SQL
INSERT [INTO] 테이블명(컬럼1, 컬럼2, ...) VALUES (값1, 값2, ...);
```

* INSERT 실습

```SQL
CREATE TABLE  testTBL1 (id INT, userName CHAR(3), age INT);

-- 컬럼명 생략시 모든 컬럼이 VALUES 값에 포함되어야 함
INSERT INTO testTBL1 VALUES(1, '홍길동', 25);

-- 컬럼명 기재시 해당 컬럼명에 맞는  값만 포함
INSERT INTO testTBL1(id, userName) VALUES(1, '강감찬')

-- 자동으로 증가하는 AUTO_INCREMENT (key : PRIMARY 또는 UNIQUE로 등록되어야 함)
CREATE TABLE testTBL2(id INT AUTO_INCREMENT PRIMARY KEY, username CHAR(3), age INT);

INSERT INTO testTBL2(userName, age) VALUES('홍길동', 30);
INSERT INTO testTBL2(userName, age) VALUES('강감찬', 35);

-- 삭제 후 INSERT 시 마지막번호 + 1로 저장됨, db가 기억하고 있음
DELETE FROM TESTTBL2 WHERE ID=3;
INSERT INTO testTBL2(userName, age) VALUES('홍길2', 30);

-- AUTO_INCREMENTAL의 초기값과 증가값 변경 예제
ALTER TABLE testTBL2 AUTO_INCREMENT=1000;
SET @@auto_increment_increment=3;

INSERT INTO testTBL2(userName, age) VALUES('길동1', 30);
INSERT INTO testTBL2(userName, age) VALUES('길동2', 30);

SELECT * FROM testtbl2
```

* 대량의 샘플 데이터 생성

```SQL
-- 형식1) 테이블이 존재하는 경우
INSERT INTO 테이블명 (컬럼1, 컬럼2, ....)
SELECT 컬럼1, 컬럼2, ... FROM .... WHERE .....

-- 테이블이 존재하는 경우 insert
INSERT INTO testtbl2(username, age)
SELECT NAME, 30 FROM usertbl;

-- 형식2) 테이블이 존재하지 않는 경우
CREATE TABLE 테이블명 [(컬럼1, 컬럼2, ...)]
SELECT 컬럼1, 컬럼2, ... FROM .... WHERE .....

-- 테이블이 존재하지 않는 경우 insert
CREATE TABLE testtbl3
SELECT userID, NAME, addr FROM usertbl
```

* 조건부 데이타 입력

​       : 기본 키가 중복된 데이터 입력 시 계속 진행

```SQL
-- memberTBL 생성 및 3개 데이타 생성
USE sqlDB;
CREATE TABLE memberTBL (SELECT userID, name, addr FROM userTbl LIMIT 3);
ALTER TABLE memberTBL
	ADD CONSTRAINT pk_memberTBL PRIMARY KEY (userID);
SELECT * FROM memberTBL;

-- 중복 데이타 입력 : 에러발생시점 이후는 수행하지 않음
INSERT INTO memberTBL VALUES('BBK', '비비코', '미국');
INSERT INTO memberTBL VALUES('SJH', '서장훈', '서울');
INSERT INTO memberTBL VALUES('HJY', '현주엽', '경기');

-- 에러나면 무시
INSERT IGNORE INTO memberTBL VALUES('BBK', '비비코', '미국');
INSERT IGNORE INTO memberTBL VALUES('SJH', '서장훈', '서울');
INSERT IGNORE INTO memberTBL VALUES('HJY', '현주엽', '경기');

-- 기본 키 중복 시 데이터 수정 : ON DUPLICATE KEY UPDATE 컬럼='값'
INSERT INTO memberTBL VALUES('BBK', '비비코', '미국')
 ON DUPLICATE KEY UPDATE name='비비코', addr='미국';
INSERT INTO memberTBL VALUES('DJM', '동짜몽', '일본')
 ON DUPLICATE KEY UPDATE name='동짜몽', addr='일본';
SELECT * FROM memberTBL;
```



# [실습 7 : 32 ~ 35p]

### 6.2.2 데이터 수정 : UPDATE

* UPDATE 형식 / 실습

```SQL
-- 형식
UPDATE 테이블명
   SET 컬럼1 = 값1, 컬럼2 = 값2, ....
 WHERE 조건;

-- testtbl3의 name='바비킴', addr을 '인천'으로
-- WHERE 생략 시 모든 데이타 변경됨 : 주의 -> 항상 건수 체크 필수
UPDATE testtbl3 
   SET addr = '인천'
 WHERE NAME='바비킴'
```



### 6.2.3 데이터 삭제 : DELETE

* DELETE 형식 / 실습

```SQL
-- 형식
DELETE FROM 테이블명
 WHERE 조건;

-- testtble3의 name='바비킴' 삭제
-- WHERE 생략 시 모든 데이타 삭제됨 : 주의 -> 항상 건수 체크 필수
DELETE FROM testtbl3 
 WHERE NAME='바비킴'
```

* 대용량 테이블 삭제

```SQL
-- DELETE : 건단위 삭제
-- DROP : 테이블 자체를 삭제
-- TRUNCATE : 테이블 구조만 남기고 데이타 모두 삭제
CREATE TABLE bigTBL1 (SELECT * FROM employees.employees);
CREATE TABLE bigTBL2 (SELECT * FROM employees.employees);
CREATE TABLE bigTBL3 (SELECT * FROM employees.employees);

DELETE FROM bigTBL1;
DROP TABLE bigTBL2;
TRUNCATE TABLE bigTBL3;

SELECT * FROM bigTBL1;
SELECT * FROM bigTBL2;
SELECT * FROM bigTBL3;
```



# [실습 8 : 36 ~ 37p]

## 6.3 WITH절과 CTE

### 6.3.1 WITH절과 CTE 개요

* CTE (Common Table Expression) : 뷰, 파생 테이블, 임시 테이블 대신 사용 가능



### 6.3.2 비재귀적 CTE

* 복잡한 쿼리 문장을 단순화

```SQL
USE sqlDB;
WITH abc(userid, total)
AS
(
SELECT userid AS '사용자', SUM(price*amount) AS '총구매액'
  FROM buyTBL
  GROUP BY userID
)
SELECT * FROM abc ORDER BY total DESC;
```

* userTBL에서 각 지역별로 가장 키가 큰 사람들의 평균 구하기

```SQL
-- STEP1 : "각 지경별로 가장 기가 큰 사람" 조회
SELECT addr, MAX(height) FROM userTBL GROUP BY addr

-- STPE2 : WITH 구문 작성
WITH cte_userTBL(addr, maxHeight)
AS
(SELECT addr, MAX(height) FROM userTBL GROUP BY addr)

-- STEP3 : 키의 평균을 구하는 쿼리 작성
SELECT AVG(maxHeight) AS '각 지역별 최고키의 평균' FROM cte_userTBL;

-- STEP4 : 2단계와 3단계 합치기
WITH cte_userTBL(addr, maxHeight)
AS
(SELECT addr, MAX(height) FROM userTBL GROUP BY addr)
SELECT AVG(maxHeight) AS '각 지역별 최고키의 평균' FROM cte_userTBL;
```



